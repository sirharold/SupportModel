flowchart TB
    %% Estilos
    classDef setupStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    classDef configStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#e65100
    classDef processStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    classDef loopStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#1b5e20
    classDef metricsStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f
    classDef ragStyle fill:#e0f7fa,stroke:#0097a7,stroke-width:2px,color:#006064
    classDef outputStyle fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#f57f17
    classDef decisionStyle fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#b71c1c

    %% FASE 1: PREPARACIÃ“N
    START([ğŸš€ INICIO]):::setupStyle
    START --> SETUP[FASE 1: PREPARACIÃ“N<br/>ğŸ“¦ InstalaciÃ³n de librerÃ­as<br/>ğŸ”Œ ConexiÃ³n Google Drive<br/>ğŸ¤– Carga de modelos]:::setupStyle

    %% FASE 2: CONFIGURACIÃ“N
    SETUP --> CONFIG[FASE 2: CONFIGURACIÃ“N<br/>ğŸ“„ Lectura archivo config<br/>â“ Carga de preguntas validadas<br/>âš™ï¸ ParÃ¡metros top-k y reranking]:::configStyle

    CONFIG --> LOADDATA[Carga de Embeddings<br/>ğŸ“Š 4 archivos Parquet<br/>ğŸ”¢ 187,031 vectores por modelo<br/>ğŸ“ Metadatos documentos]:::configStyle

    %% FASE 3: LOOP POR MODELO
    LOADDATA --> MODELLOOP{Para cada modelo<br/>Ada, E5-Large<br/>MPNet, MiniLM}:::loopStyle

    %% FASE 4: LOOP POR PREGUNTA
    MODELLOOP -->|Siguiente modelo| QLOOP{Para cada pregunta<br/>en configuraciÃ³n}:::loopStyle

    %% GeneraciÃ³n de embedding de consulta
    QLOOP -->|Siguiente pregunta| GENEMB[GeneraciÃ³n Embedding Consulta<br/>ğŸ”¤ Pregunta â†’ Vector<br/>ğŸ“ DimensiÃ³n segÃºn modelo<br/>OpenAI API para Ada<br/>SentenceTransformers para otros]:::processStyle

    %% BÃºsqueda por similitud
    GENEMB --> SEARCH[BÃšSQUEDA VECTORIAL<br/>ğŸ“Š Similitud coseno<br/>ğŸ” vs 187,031 documentos<br/>ğŸ“ˆ Ordenamiento descendente]:::processStyle

    %% RecuperaciÃ³n de top-k
    SEARCH --> TOPK[RecuperaciÃ³n Top-K<br/>ğŸ“‹ Top-15 documentos<br/>ğŸ”— Links, tÃ­tulos, contenido<br/>ğŸ’¯ Scores de similitud coseno]:::processStyle

    %% MÃ©tricas PRE-RERANKING
    TOPK --> PREKLOOP{Para cada k<br/>1, 3, 5, 10, 15}:::loopStyle

    PREKLOOP --> PREMETRICS[CÃLCULO MÃ‰TRICAS @k PRE-RERANKING<br/>âœ“ Precision@k<br/>âœ“ Recall@k<br/>âœ“ F1@k<br/>âœ“ NDCG@k<br/>âœ“ MAP@k<br/>âœ“ MRR@k]:::metricsStyle

    PREMETRICS --> PREKLOOP
    PREKLOOP -->|Completado| STOREPRE[ğŸ’¾ Almacenar mÃ©tricas<br/>PRE-reranking]:::metricsStyle

    %% RERANKING CON CROSSENCODER
    STOREPRE --> RERANK[RERANKING CROSSENCODER<br/>ğŸ§  Modelo: mxbai-rerank-xsmall-v1<br/>ğŸ“Š Procesamiento tÃ­tulo + contenido<br/>ğŸ¯ Scores de relevancia]:::processStyle

    RERANK --> NORMALIZE[NormalizaciÃ³n Min-Max<br/>ğŸ“ Scores entre 0 y 1<br/>ğŸ”„ Reordenamiento final]:::processStyle

    %% MÃ©tricas POST-RERANKING
    NORMALIZE --> POSTKLOOP{Para cada k<br/>1, 3, 5, 10, 15}:::loopStyle

    POSTKLOOP --> POSTMETRICS[CÃLCULO MÃ‰TRICAS @k POST-RERANKING<br/>âœ“ Precision@k<br/>âœ“ Recall@k<br/>âœ“ F1@k<br/>âœ“ NDCG@k<br/>âœ“ MAP@k<br/>âœ“ MRR@k<br/>âœ“ CrossEncoder Score]:::metricsStyle

    POSTMETRICS --> POSTKLOOP
    POSTKLOOP -->|Completado| STOREPOST[ğŸ’¾ Almacenar mÃ©tricas<br/>POST-reranking]:::metricsStyle

    %% MÃ‰TRICAS RAG
    STOREPOST --> GENANS[GeneraciÃ³n de Respuesta<br/>ğŸ’¬ GPT-3.5-turbo<br/>ğŸ“ Contexto: Top-3 documentos<br/>ğŸ² Temperature=0 determinÃ­stico]:::ragStyle

    GENANS --> RAGMETRICS[MÃ‰TRICAS RAGAS<br/>ğŸ“Š Single API call combinada<br/>âœ“ Faithfulness 1-5<br/>âœ“ Answer Relevancy 1-5<br/>âœ“ Answer Correctness 1-5<br/>âœ“ Context Precision 1-5<br/>âœ“ Context Recall 1-5<br/>ğŸ”„ NormalizaciÃ³n 0 a 1]:::ragStyle

    RAGMETRICS --> BERTSCORE[MÃ‰TRICAS BERTSCORE<br/>ğŸ“ Modelo: DeBERTa-base-mnli<br/>âœ“ Precision semÃ¡ntica<br/>âœ“ Recall semÃ¡ntico<br/>âœ“ F1 semÃ¡ntico<br/>ğŸ”— Semantic Similarity MPNet]:::ragStyle

    BERTSCORE --> STORERAG[ğŸ’¾ Almacenar mÃ©tricas RAG]:::ragStyle

    %% Continuar loop
    STORERAG --> QLOOP

    %% Fin del loop de preguntas
    QLOOP -->|Todas evaluadas| AVGMETRICS[CÃ¡lculo de Promedios<br/>ğŸ“Š AgregaciÃ³n de mÃ©tricas<br/>ğŸ“ˆ EstadÃ­sticas del modelo<br/>ğŸ’¯ Tasas de Ã©xito]:::processStyle

    AVGMETRICS --> MODELLOOP

    %% Fin del loop de modelos y guardado
    MODELLOOP -->|Todos evaluados| SAVERESULTS[GUARDADO DE RESULTADOS<br/>ğŸ“¦ Estructura JSON compatible Streamlit<br/>ğŸ’¾ cumulative_results_YYYYMMDD_HHMMSS.json<br/>ğŸ• Timestamp zona Chile<br/>ğŸ“Š MÃ©tricas por modelo y agregadas<br/>ğŸ”¬ Metadata de verificaciÃ³n]:::outputStyle

    SAVERESULTS --> END([ğŸ‰ FIN]):::setupStyle
